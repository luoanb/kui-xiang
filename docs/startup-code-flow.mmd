flowchart TB
  subgraph Electron Main Process
    A1["app.whenReady()"] --> A2["createWindow()"]
    A2 --> A3["BrowserWindow 创建 & webPreferences preload"]
    A3 --> A4{"VITE_DEV_SERVER_URL?"}
    A4 -->|是| A5["win.loadURL(VITE_DEV_SERVER_URL)"]
    A4 -->|否| A6["win.loadFile(dist/index.html)"]
    A5 --> A7["win.webContents.openDevTools() 可选"]
    A6 --> A8["可选打开 DevTools"]
    A3 --> A9["win.webContents.on('did-finish-load')<br/>send 'main-process-message'"]
    A2 --> B1["initialize AppUpdater"]
    A2 --> B2["new Ipc() 初始化 ipcMain handlers"]
    A2 --> B3["Playground 初始化"]
    A2 --> B4["globalShortcut 注册快捷键"]
    A2 --> C1["startEggServer()"]
    C1 --> C2["session.resolveProxy() 获取系统代理"]
    C2 --> C3["设置 process.env.http_proxy/https_proxy"]
    C1 --> C4["egg.start({ baseDir })"]
    C4 --> C5["appServer.listen(7002)"]
    C4 --> C6["global.eggApp = appServer"]
  end

  subgraph EggJS Boot
    D1["AppBootHook.configWillLoad()"] --> D2["AppBootHook.willReady()"]
    D2 --> D3["initializeProxy()"]
    D2 --> D4["检查并创建数据库目录"]
    D2 --> D5["await this.app.model.sync({ alter: true })"]
    D5 --> D6["同步成功或处理 UniqueConstraintError 重试"]
    D6 --> D7["AppBootHook.didReady() -> updateDatabase scripts"]
    D7 --> D8["serverDidReady -> HTTP server 已启动"]
    D8 --> M1["MCP Service (mcp.service.js)"]
    M1 --> M2["McpService.ensureInitialized() (lazy) -> initByConfig()"]
    M2 --> M3["connectServer(key) -> 使用 stdio/SSE 连接 MCP"]
  end

  subgraph IPC Handlers
    I1["new Ipc().init()"] --> I2["ipcMain.handle('get-app-version')"]
    I2 --> I3["路径/文件管理 handlers"]
    I3 --> I4["下载管理 handlers 使用 downloader 工厂"]
    I4 --> I5["read/save mcp config handlers"]
    I5 --> I6["restart-mcp-server -> global.eggApp.messenger.sendToApp"]
    I6 --> M1["(可触发) EggJS 内部调用 mcp.service.restartServer()"]
    I4 --> I7["download-tool -> downloader.downloadTool()<br/>监听 taskCompleted/taskFailed"]
  end

  subgraph Frontend
    R1["src/main.ts createApp() & mount('#app')"] --> R2["postMessage removeLoading"]
    R2 --> R3["调用 init() (src/lib/init.js)"]
    R3 --> R4["引用 ./demos/ipc -> 使用 window.ipcRenderer.invoke"]
    R4 --> R5["调用 ipc: start-download-task, startEggServer 等"]
    R5 -->|HTTP| R6["调用后端 API (http://localhost:7002)"]
    R6 --> M2["触发 MCP 初始化（如 /api/mcp/listAllTools）"]
    R5 -->|IPC| M1["与主进程通信: open-win, toggle-devtools, open-url, set-mini-mode"]
  end

  A1 --> D1
  C5 --> R6
  I4 --> downloader["downloader 实例"]
  style downloader fill:#f9f,stroke:#333,stroke-width:1px
