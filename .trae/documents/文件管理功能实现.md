## 文件管理功能实现计划（不含MCP）

### 1. 后端实现

#### 1.1 扩展项目服务
* **目标文件**：`electron/server/app/service/project.js`
* **新增功能**：直接使用Node.js的`fs`模块实现文件系统操作
  * `getDirectoryChildren` - 获取指定路径的直接子目录/文件（每次只返回一层）
  * `readFile` - 读取文件内容
  * `writeFile` - 写入文件内容
  * `createFile` - 创建文件
  * `createDirectory` - 创建目录
  * `deleteFile` - 删除文件
  * `deleteDirectory` - 删除目录
  * `renameFile` - 重命名文件/目录

#### 1.2 新增文件管理控制器
* **实现文件**：`electron/server/app/controller/file.js`
* **功能**：处理文件系统相关的HTTP请求
* **核心实现**：每次只返回当前路径的直接子目录/文件，不递归加载

#### 1.3 新增路由
* **目标文件**：`electron/server/app/router.js`
* **新增路由**：
  * `GET /api/file/children` - 获取指定路径的直接子目录/文件（核心接口，每次返回一层）
  * `GET /api/file/read` - 读取文件内容
  * `POST /api/file/write` - 写入文件内容
  * `POST /api/file/create` - 创建文件/目录
  * `DELETE /api/file/delete` - 删除文件/目录
  * `PUT /api/file/rename` - 重命名文件/目录

### 2. 前端实现

#### 2.1 封装文件管理组件
* **组件结构**：
  * 左侧：目录树（每次只加载一层）
  * 右侧：当前打开的文件内容
* **功能**：
  * 目录树：每次点击展开时只加载直接子目录
  * 文件内容：显示和编辑当前打开的文件
  * 文件操作：创建、删除、重命名
* **实现文件**：`src/components/FileManager.vue`

#### 2.2 目录树组件（核心实现）
* **实现文件**：`src/components/DirectoryTree.vue`
* **核心逻辑**：
  * 初始只显示当前目录的直接子目录/文件
  * 点击展开按钮时，仅加载该目录的直接子目录/文件
  * 每个目录项显示加载状态
  * 不预加载任何子目录的子目录
* **目录节点状态**：
  * `name`: 节点名称
  * `path`: 节点路径
  * `type`: 文件类型（file/directory）
  * `children`: 子节点列表（初始为null，表示未加载）
  * `loading`: 是否正在加载子节点
  * `expanded`: 是否展开
  * `hasChildren`: 是否有子节点（用于显示展开图标）

#### 2.3 新增文件管理抽屉
* **实现文件**：`src/components/FileManagerDrawer.vue`
* **使用 SidebarProvider**：与现有侧边栏保持一致的UI风格
* **引入文件管理组件**：在抽屉中集成FileManager组件

#### 2.4 修改对话页按钮行为
* **目标文件**：`src/pages/team.vue`
* **修改点**：
  * 将右侧侧边栏（`sidebarRightOpen`）的内容从`SidebarRightTeam`替换为文件管理抽屉
  * 修改按钮点击事件，打开文件管理抽屉而非团队提示词

#### 2.5 集成项目存储
* **使用现有store**：`src/stores/project.ts`
* **功能**：
  * 获取当前打开的文件夹
  * 历史记录管理
  * 文件夹选择

#### 2.6 创建文件系统API
* **实现文件**：`src/api/file.ts`
* **功能**：
  * 封装后端文件系统API
  * 处理文件系统相关请求

### 3. 核心实现细节

#### 3.1 后端实现（直接使用fs模块）
* **API设计**：
  * `GET /api/file/children?path=xxx` - 获取指定路径的直接子目录/文件
  * 返回数据格式：
    ```json
    {
      "path": "xxx",
      "children": [
        {
          "name": "dir1",
          "path": "xxx/dir1",
          "type": "directory",
          "hasChildren": true
        },
        {
          "name": "file1.txt",
          "path": "xxx/file1.txt",
          "type": "file",
          "size": 123
        }
      ]
    }
    ```

#### 3.2 前端实现
* **目录树节点状态管理**：
  * 每个目录节点包含：`name`, `path`, `type`, `children`, `loading`, `expanded`, `hasChildren`
  * `children`初始为`null`或`[]`，表示未加载
  * `loading`标识是否正在加载子目录
  * `hasChildren`标识是否有子目录，用于显示展开图标

* **展开事件处理**：
  ```javascript
  async function handleExpand(node) {
    if (node.children !== null && node.children.length > 0) {
      node.expanded = true;
      return;
    }
    
    try {
      node.loading = true;
      const result = await fileApi.getChildren(node.path);
      node.children = result.children;
      node.expanded = true;
    } catch (error) {
      console.error('Failed to load directory children:', error);
    } finally {
      node.loading = false;
    }
  }
  ```

### 4. 实现步骤

1. **后端实现**：
   * 扩展`project.js`服务，添加文件系统相关方法，直接使用Node.js的`fs`模块
   * 创建`file.js`控制器，实现文件系统相关的API
   * 新增路由，包括核心的`/api/file/children`接口

2. **前端实现**：
   * 创建`DirectoryTree.vue`组件，实现每次只加载一层的目录树
   * 创建`FileManager.vue`组件，集成目录树和文件编辑器
   * 创建`FileManagerDrawer.vue`组件，实现文件管理抽屉
   * 修改`team.vue`，将右侧侧边栏替换为文件管理抽屉
   * 创建`file.ts`API，封装后端接口

3. **测试**：
   * 测试目录树的懒加载功能，确保每次只加载一层
   * 测试文件操作功能
   * 测试对话页按钮行为

### 5. 技术要点

* **严格的一层加载**：确保后端只返回直接子目录/文件，前端只加载一层
* **安全考虑**：
  * 验证文件路径，防止越界访问
  * 限制文件操作权限
  * 日志记录所有文件操作
* **高效的状态管理**：管理目录节点的加载状态、展开状态和子节点数据
* **良好的用户体验**：显示加载状态，提供清晰的视觉反馈
* **与现有系统集成**：保持UI一致性

### 6. 预期效果

1. **目录树**：
   * 初始只显示当前目录的直接子目录/文件
   * 点击展开目录时，仅加载该目录的直接子目录/文件
   * 每次只加载一层，不递归加载
   * 显示加载状态，提升用户体验

2. **文件管理功能**：
   * 支持文件的创建、编辑、保存、删除和重命名
   * 支持目录的创建、删除和重命名
   * 提供清晰的文件操作反馈

3. **对话页**：
   * 右侧侧边栏按钮点击后打开文件管理抽屉
   * 保持与现有UI风格一致

通过以上实现，将为用户提供完整的文件管理功能，目录树支持懒加载，提升性能和用户体验。